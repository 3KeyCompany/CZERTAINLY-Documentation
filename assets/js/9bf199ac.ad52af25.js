"use strict";(self.webpackChunkczertainly=self.webpackChunkczertainly||[]).push([[4296],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return d}});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var c=r.createContext({}),s=function(e){var t=r.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=s(e.components);return r.createElement(c.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,c=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),m=s(n),d=a,f=m["".concat(c,".").concat(d)]||m[d]||u[d]||i;return n?r.createElement(f,o(o({ref:t},p),{},{components:n})):r.createElement(f,o({ref:t},p))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=m;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var s=2;s<i;s++)o[s]=n[s];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},2220:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return c},metadata:function(){return s},toc:function(){return p},default:function(){return m}});var r=n(7462),a=n(3366),i=(n(7294),n(3905)),o=["components"],l={},c="Kubernetes cert-manager",s={unversionedId:"protocols/acme/cert-manager",id:"protocols/acme/cert-manager",title:"Kubernetes cert-manager",description:"One of the most common use cases for ACME is to manage certificates for containerized applications and environment like Kubernetes.",source:"@site/docs/07-protocols/02-acme/11-cert-manager.md",sourceDirName:"07-protocols/02-acme",slug:"/protocols/acme/cert-manager",permalink:"/docs/protocols/acme/cert-manager",tags:[],version:"current",sidebarPosition:11,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"ACME Accounts",permalink:"/docs/protocols/acme/acme-account"},next:{title:"Feedback and Support",permalink:"/docs/feedback-support"}},p=[{value:"Prerequisites",id:"prerequisites",children:[],level:2},{value:"Configuration of <code>ACME Profile</code>",id:"configuration-of-acme-profile",children:[],level:2},{value:"Enable ACME protocol for <code>RA Profile</code>",id:"enable-acme-protocol-for-ra-profile",children:[],level:2},{value:"Create new <code>ClusterIssuer</code>",id:"create-new-clusterissuer",children:[],level:2},{value:"Request certificate",id:"request-certificate",children:[],level:2}],u={toc:p};function m(e){var t=e.components,n=(0,a.Z)(e,o);return(0,i.kt)("wrapper",(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"kubernetes-cert-manager"},"Kubernetes cert-manager"),(0,i.kt)("p",null,"One of the most common use cases for ACME is to manage certificates for containerized applications and environment like Kubernetes."),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://cert-manager.io/"},(0,i.kt)("inlineCode",{parentName:"a"},"cert-manager"))," adds certificates and certificate issuers as resource types in Kubernetes clusters, and simplifies the process of obtaining, renewing and using those certificates. It can issue certificates from a variety of supported sources, including ACME compliant servers."),(0,i.kt)("p",null,"For more information about ",(0,i.kt)("inlineCode",{parentName:"p"},"cert-manager"),", refer to the ",(0,i.kt)("a",{parentName:"p",href:"https://cert-manager.io/docs/"},"cert-manager documentation"),"."),(0,i.kt)("p",null,"CZERTAINLY platform supports ACME implementation according the ",(0,i.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc8555"},"RFC 8555"),". This guide shows, how you can use ",(0,i.kt)("inlineCode",{parentName:"p"},"cert-manager")," to manage certificates using ACME protocol and certificate management services controlled by the platform. In this combination, ",(0,i.kt)("inlineCode",{parentName:"p"},"cert-manager")," can manage certificates provided by literally any certification authority."),(0,i.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,i.kt)("p",null,"Before you can configure ",(0,i.kt)("inlineCode",{parentName:"p"},"cert-manager")," with the CZERTAINLY, you need to have the following:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Kubernetes cluster with ",(0,i.kt)("inlineCode",{parentName:"li"},"cert-manager")," installed"),(0,i.kt)("li",{parentName:"ul"},"Configured at least one ",(0,i.kt)("inlineCode",{parentName:"li"},"RA Profile")," certificate service"),(0,i.kt)("li",{parentName:"ul"},"Access to HTTP or DNS resources, that will be used to validate ACME challenges")),(0,i.kt)("p",null,"For this guide, we will use ",(0,i.kt)("inlineCode",{parentName:"p"},"http-01")," challenge validation and we will assume that the ACME protocol should be enabled for the ",(0,i.kt)("inlineCode",{parentName:"p"},"RA Profile")," with name ",(0,i.kt)("inlineCode",{parentName:"p"},"czertainly")," and know UUID ",(0,i.kt)("inlineCode",{parentName:"p"},"61c7d882-9336-4c9e-b380-8d2fd83f7c26"),".\nIn case you do not have the ",(0,i.kt)("inlineCode",{parentName:"p"},"cert-manager")," installed, follow the ",(0,i.kt)("a",{parentName:"p",href:"https://cert-manager.io/docs/installation/"},"installation instructions")," to install it."),(0,i.kt)("h2",{id:"configuration-of-acme-profile"},"Configuration of ",(0,i.kt)("inlineCode",{parentName:"h2"},"ACME Profile")),(0,i.kt)("p",null,"First step is to configure the ",(0,i.kt)("a",{parentName:"p",href:"acme-profile"},(0,i.kt)("inlineCode",{parentName:"a"},"ACME Profile")),". It will create an instance of the ACME server with specific attributes that will be used to control the certificate management process and ACME clients will need to follow. You can create as many ",(0,i.kt)("inlineCode",{parentName:"p"},"ACME Profiles")," as you need. Each of them can have a different configuration, validation limits, terms of service, etc."),(0,i.kt)("p",null,"We do not need to configure default ",(0,i.kt)("inlineCode",{parentName:"p"},"RA Profile"),", we will enable ACME protocol for a specific ",(0,i.kt)("inlineCode",{parentName:"p"},"RA Profile")," with name ",(0,i.kt)("inlineCode",{parentName:"p"},"czertainly"),". Let's do this in ",(0,i.kt)("inlineCode",{parentName:"p"},"czertainly")," ",(0,i.kt)("inlineCode",{parentName:"p"},"RA Profile")," configuration."),(0,i.kt)("p",null,"We will create ",(0,i.kt)("inlineCode",{parentName:"p"},"ACME Profile")," named ",(0,i.kt)("inlineCode",{parentName:"p"},"ACME CZERTAINLY Profile")," using the ",(0,i.kt)("a",{parentName:"p",href:"/api/core-acme/#operation/createAcmeProfile"},"Core ACME API"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'curl -X POST \\\n  --cacert [ca-cert] \\\n  --cert [client-cert] \\\n  --cert-type [type] \\\n  -H "Content-Type: application/json" \\\n  -H "Accept: application/json" \\\n  --data \'\n  {\n    "name": "ACME CZERTAINLY Profile",\n    "description": "Sample ACME Profile",\n    "termsOfServiceUrl": "https://www.example.com/termsOfService",\n    "websiteUrl": "https://www.example.com",\n    "dnsResolverIp": "8.8.8.8",\n    "dnsResolverPort": "53",\n    "retryInterval": 60,\n    "validity": 3000,\n    "requireContact": true,\n    "requireTermsOfService": true\n  }\' \\\n  https://[domain]:[port]/api/v1/acmeProfiles\n')),(0,i.kt)("p",null,"When the ",(0,i.kt)("inlineCode",{parentName:"p"},"ACME Profile")," is successfully created, its ",(0,i.kt)("inlineCode",{parentName:"p"},"uuid")," is sent back:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "uuid": "b6be5014-b8f8-4b4f-b96d-a54c38f54b48"\n}\n')),(0,i.kt)("h2",{id:"enable-acme-protocol-for-ra-profile"},"Enable ACME protocol for ",(0,i.kt)("inlineCode",{parentName:"h2"},"RA Profile")),(0,i.kt)("p",null,"Once the ",(0,i.kt)("inlineCode",{parentName:"p"},"ACME Profile")," is ready, we can enable ACME protocol for the ",(0,i.kt)("inlineCode",{parentName:"p"},"RA Profile")," with name ",(0,i.kt)("inlineCode",{parentName:"p"},"czertainly"),". For that purpose we will use the ",(0,i.kt)("a",{parentName:"p",href:"/api/core-raprofile/#operation/activateAcmeForRaProfile"},(0,i.kt)("inlineCode",{parentName:"a"},"Core RA Profile API")),". We will need to configure ",(0,i.kt)("inlineCode",{parentName:"p"},"Attributes")," to issue and revoke certificates, if there are any available and supported in the ",(0,i.kt)("inlineCode",{parentName:"p"},"RA Profile"),". These ",(0,i.kt)("inlineCode",{parentName:"p"},"Attributes")," will be statically attached to all ACME requests that are processed."),(0,i.kt)("p",null,"You can get the list of ",(0,i.kt)("inlineCode",{parentName:"p"},"Attributes")," using the following APIs:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/api/core-raprofile/#operation/listIssueCertificateAttributes"},"Get issue Attributes")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"/api/core-raprofile/#operation/listRevokeCertificateAttributes"},"Get revocation Attributes"))),(0,i.kt)("p",null,"We will enable ACME for ",(0,i.kt)("inlineCode",{parentName:"p"},"czertainly")," ",(0,i.kt)("inlineCode",{parentName:"p"},"RA Profile"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'curl -X POST \\\n  --cacert [ca-cert] \\\n  --cert [client-cert] \\\n  --cert-type [type] \\\n  -H "Content-Type: application/json" \\\n  -H "Accept: application/json" \\\n  --data \'\n  {\n    "acmeProfileUuid": "b6be5014-b8f8-4b4f-b96d-a54c38f54b48",\n    "issueCertificateAttributes": [],\n    "revokeCertificateAttributes": []\n  }\' \\\n  https://[domain]:[port]/api/v1/raprofiles/61c7d882-9336-4c9e-b380-8d2fd83f7c26/activateAcme\n  #https://[domain]:[port]/api/v1/raprofiles/{uuid}/activateAcme\n')),(0,i.kt)("p",null,"When succeed, we will receive in the response ACME server directory endpoint to use:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "uuid": "b6be5014-b8f8-4b4f-b96d-a54c38f54b48",\n    "name": "ACME CZERTAINLY Profile",\n    "directoryUrl": "https://[domain]:[port]/api/acme/raProfile/czertainly/directory",\n    "issueCertificateAttributes": [],\n    "revokeCertificateAttributes": [],\n    "acmeAvailable": true\n}\n')),(0,i.kt)("p",null,"Now we have the ACME protocol enabled for ",(0,i.kt)("inlineCode",{parentName:"p"},"RA Profile")," with name ",(0,i.kt)("inlineCode",{parentName:"p"},"czertainly"),", based on the ",(0,i.kt)("inlineCode",{parentName:"p"},"ACME Profile")," with name ",(0,i.kt)("inlineCode",{parentName:"p"},"ACME CZERTAINLY Profile"),"."),(0,i.kt)("h2",{id:"create-new-clusterissuer"},"Create new ",(0,i.kt)("inlineCode",{parentName:"h2"},"ClusterIssuer")),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"ClusterIssuer")," referencing our configured ACME service can be configured using the following manifest file:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: cert-manager.io/v1\nkind: ClusterIssuer\nmetadata:\n  name: clusterissuer-czertainly-acme\n  #namespace: default\nspec:\n  acme:\n    server: https://[domain]:[port]/api/acme/raProfile/czertainly/directory\n    # Email address used for ACME registration\n    email: www@example.com\n    # Name of a secret used to store the ACME account private key\n    privateKeySecretRef:\n      name: issuer-czertainly-acme-secret\n    # Enable HTTP01 validations\n    solvers:\n    # An empty 'selector' means that this solver matches all domains\n    - selector: {}\n      http01:\n        ingress:\n          class: public\n")),(0,i.kt)("p",null,"You should adjust this manifest according to your specific Kubernetes cluster. If the CZERTAINLY access point is using TLS certificate issued from private certification authority, you should include the CA certificate in ",(0,i.kt)("inlineCode",{parentName:"p"},"cert-manager")," configuration, otherwise it will reject communication."),(0,i.kt)("p",null,"When you are ready, you can apply the manifest. This will start the communication with the ACME server and register the ACME client. You can check if the registration of ACME client was successful by ",(0,i.kt)("a",{parentName:"p",href:"/api/core-acme/#operation/listAcmeAccount"},"listing all ACME Clients")," in the platform and checking the state of the ",(0,i.kt)("inlineCode",{parentName:"p"},"ClusterIssuer"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl describe -n cert-manager clusterissuers.cert-manager.io clusterissuer-czertainly-acme\n")),(0,i.kt)("p",null,"You should see the status of the ",(0,i.kt)("inlineCode",{parentName:"p"},"ClusterIssuer")," indicating ",(0,i.kt)("inlineCode",{parentName:"p"},"ACMEAccountRegistered"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"...\nStatus:\n  Acme:\n    Last Registered Email:  www@example.com\n    Uri:                    https://[domain]:[port]/api/acme/cm/acct/KUAkYavhiMI\n  Conditions:\n    Last Transition Time:  2022-01-29T16:25:45Z\n    Message:               The ACME account was registered with the ACME server\n    Observed Generation:   1\n    Reason:                ACMEAccountRegistered\n    Status:                True\n    Type:                  Ready\nEvents:                    <none>\n")),(0,i.kt)("p",null,"That means that the ACME client was registered successfully and you can start managing certificates."),(0,i.kt)("h2",{id:"request-certificate"},"Request certificate"),(0,i.kt)("p",null,"You can try to issue certificate using the following manifest:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: cert-manager.io/v1\nkind: Certificate\nmetadata:\n  name: cert-www-example-com\n  namespace: default\nspec:\n  secretName: cert-secret-www-example-com\n  renewBefore: 365h # 15d\n  issuerRef:\n    name: clusterissuer-czertainly-acme\n    kind: ClusterIssuer\n  commonName: www.example.com\n  dnsNames:\n  - www.example.com\n")),(0,i.kt)("p",null,"Applying this manifest in Kubernetes environment will start the ACME certificate issuing process. The brief steps what the ",(0,i.kt)("inlineCode",{parentName:"p"},"cert-manager")," will do are:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"generate new key pair and CSR, and store in the Secret"),(0,i.kt)("li",{parentName:"ul"},"create Order resource in the ACME server"),(0,i.kt)("li",{parentName:"ul"},"distribute the Challenge for validation"),(0,i.kt)("li",{parentName:"ul"},"ask ACME server for the Challenge to be validated"),(0,i.kt)("li",{parentName:"ul"},"sends the CSR to the ACME server to finalize"),(0,i.kt)("li",{parentName:"ul"},"download the certificate from the ACME server")),(0,i.kt)("p",null,"You can check the status of certificate resource in Kubernetes to see the result of the certificate issuing process:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl describe certificates.cert-manager.io cert-www-example-com\n")),(0,i.kt)("p",null,"When the certificate was issued and stored, you will see similar output:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"...\nStatus:\n  Conditions:\n    Last Transition Time:  2022-02-03T10:33:52Z\n    Message:               Certificate is up to date and has not expired\n    Observed Generation:   1\n    Reason:                Ready\n    Status:                True\n    Type:                  Ready\n  Not After:               2024-02-03T10:22:51Z\n  Not Before:              2022-02-03T10:22:51Z\n  Renewal Time:            2024-01-19T05:22:51Z\n  Revision:                1\nEvents:                    <none>\n")),(0,i.kt)("p",null,"The issued certificate is also included in the certificate inventory of the platform.\nFrom now on, the ",(0,i.kt)("inlineCode",{parentName:"p"},"cert-manager")," will renew the certificate automatically."))}m.isMDXComponent=!0}}]);